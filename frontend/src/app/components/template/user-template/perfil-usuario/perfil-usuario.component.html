<div class="profile-container">
  <!-- Profile Header -->
  <div class="profile-header">
    <div class="profile-avatar">
      <img [src]="userProfile.profileImage" [alt]="userProfile.name">
    </div>
    <div class="profile-info">
      <h1>{{ formGroup.get('nome')?.value }}</h1>
      <p>{{ formGroup.get('email')?.value }}</p>
    </div>
  </div>

  <!-- Tab Navigation -->
  <div class="tab-navigation">
    <button 
      class="tab-button" 
      [class.active]="activeTab === 1"
      (click)="setActiveTab(1)">
      <i class="material-icons">person</i>
      Informações Pessoais
    </button>
    <button 
      class="tab-button" 
      [class.active]="activeTab === 2"
      (click)="setActiveTab(2)">
      <i class="material-icons">location_on</i>
      Endereços
    </button>
    <button 
      class="tab-button" 
      [class.active]="activeTab === 3"
      (click)="setActiveTab(3)">
      <i class="material-icons">credit_card</i>
      Cartões
    </button>
    <button 
      class="tab-button" 
      [class.active]="activeTab === 4"
      (click)="setActiveTab(4)">
      <i class="material-icons">favorite</i>
      Lista de Desejos
    </button>
  </div>

  <!-- Tab Content -->
  <div class="tab-content">
    
    <!-- Tab 1: Personal Information -->
    <div *ngIf="activeTab === 1" class="tab-panel personal-info">
      <h2>Informações Pessoais</h2>
      
      <!-- Profile Image Upload -->
      <div class="image-upload-section">
        <div class="current-image">
          <img [src]="imagePreview || userProfile.profileImage" [alt]="userProfile.name">
        </div>
        <div class="upload-controls">
          <input type="file" id="profileImage" accept="image/*" (change)="onFileSelected($event)" style="display: none;">
          <button class="btn-secondary" onclick="document.getElementById('profileImage').click()">
            <i class="material-icons">photo_camera</i>
            Alterar Foto
          </button>
          <p class="upload-hint">JPG, JPEG e PNG. Máximo 10MB.</p>
        </div>
      </div>
      
      <!-- Personal Info Form -->
      <form [formGroup]="formGroup" class="personal-form">
        <div class="form-row">
          <div class="form-group">
            <label for="nome">Nome Completo</label>
            <mat-form-field appearance="outline" class="full-width">
            <!-- <mat-label>Nome</mat-label> -->
            <input id="nome" matInput type="text" formControlName="nome" />
            <mat-error
              *ngIf="
                formGroup.get('nome') &&
                formGroup.get('nome')?.invalid &&
                formGroup.get('nome')?.touched
              ">
              {{getErrorMessage('nome', formGroup.get('nome')?.errors)}}

              @if (formGroup.get('nome')?.hasError('apiError')) {
                  <span> {{ formGroup.get('nome')?.getError('apiError') }}</span>
              }
            </mat-error>
          </mat-form-field>
          </div>
          
          <div class="form-group">
            <label for="cpf">CPF</label>
            <mat-form-field appearance="outline" class="full-width">
            <!-- <mat-label>CPF</mat-label> -->
            <input matInput type="text" formControlName="cpf" onkeypress="return /^[0-9]+$/.test(event.key)"/>
            <mat-error
              *ngIf="
                formGroup.get('cpf') &&
                formGroup.get('cpf')?.invalid &&
                formGroup.get('cpf')?.touched
              ">
              {{getErrorMessage('cpf', formGroup.get('cpf')?.errors)}}

              @if (formGroup.get('cpf')?.hasError('apiError')) {
                  <span> {{ formGroup.get('cpf')?.getError('apiError') }}</span>
              }
            </mat-error>
          </mat-form-field>
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="email">E-mail</label>
            <mat-form-field appearance="outline" class="full-width">
            <input matInput type="email" formControlName="email" required />
            <mat-error
              *ngIf="
                formGroup.get('email') &&
                formGroup.get('email')?.hasError('required') &&
                formGroup.get('email')?.touched
              ">
              {{getErrorMessage('email', formGroup.get('email')?.errors)}}

              @if (formGroup.get('email')?.hasError('apiError')) {
                  <span> {{ formGroup.get('email')?.getError('apiError') }}</span>
              }
            </mat-error>
          </mat-form-field>
          </div>
          
          <div class="form-group">
            <label for="dataNascimento">Data de Nascimento</label>
            <mat-form-field appearance="outline" class="full-width">
            <!-- <mat-label>Data de Nascimento</mat-label> -->
            <input id="dataNascimento" matInput [matDatepicker]="picker" formControlName="dataNascimento" [max]="maxDate" />
            <mat-hint>Clique no calendário para escolher a data</mat-hint>
            <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
            <mat-datepicker #picker></mat-datepicker>
            <mat-error
              *ngIf="
                formGroup.get('dataNascimento') &&
                formGroup.get('dataNascimento')?.invalid &&
                formGroup.get('dataNascimento')?.touched
              ">
              {{getErrorMessage('dataNascimento', formGroup.get('dataNascimento')?.errors)}}

              @if (formGroup.get('dataNascimento')?.hasError('apiError')) {
                  <span> {{ formGroup.get('dataNascimento')?.getError('apiError') }}</span>
              }
            </mat-error>
          </mat-form-field>
          </div>
        </div>
        
        <div class="form-actions">
          <button type="button" class="btn-primary" (click)="salvar()">
            Salvar Alterações
          </button>
          <button type="button" class="btn-outline" (click)="showPasswordForm = true">
            Alterar Senha
          </button>
        </div>
      </form>
      
      <!-- Password Change Form -->
      <div *ngIf="showPasswordForm" class="password-form">
        <h3>Alterar Senha</h3>
        <form [formGroup]="passwordForm">
          <div class="form-group">
            <label for="currentPassword">Senha Atual</label>
            <input type="password" id="currentPassword" formControlName="currentPassword">
            <div *ngIf="hasError(passwordForm, 'currentPassword')" class="error-message">
              Senha atual é obrigatória
            </div>
          </div>
          
          <div class="form-group">
            <label for="newPassword">Nova Senha</label>
            <input type="password" id="newPassword" formControlName="newPassword">
            <div *ngIf="hasError(passwordForm, 'newPassword')" class="error-message">
              Nova senha deve ter pelo menos 6 caracteres
            </div>
          </div>
          
          <div class="form-group">
            <label for="confirmPassword">Confirmar Nova Senha</label>
            <input type="password" id="confirmPassword" formControlName="confirmPassword">
            <div *ngIf="hasError(passwordForm, 'confirmPassword')" class="error-message">
              Confirmação de senha é obrigatória
            </div>
          </div>
          
          <div class="form-actions">
            <button type="button" class="btn-primary" (click)="changePassword()">
              Alterar Senha
            </button>
            <button type="button" class="btn-outline" (click)="showPasswordForm = false">
              Cancelar
            </button>
          </div>
        </form>
      </div>
    </div>
    
    <!-- Tab 2: Addresses -->
    <div *ngIf="activeTab === 2" class="tab-panel addresses">
      <div class="section-header">
        <h2>Meus Endereços</h2>
        <button class="btn-primary" (click)="adicionarEnderecoDialog()">
          <i class="material-icons">add</i>
          Adicionar Endereço
        </button>
      </div>
      
      <!-- Address List -->
      <div class="address-list">
        <div *ngFor="let endereco of listaEndereco; let i = index" class="address-card">
          <div class="address-header">
            <h3>Endereço {{ i + 1 }}</h3>
            <span *ngIf="listaEndereco[0] == endereco" class="primary-badge">Principal</span>
          </div>
          
          <div class="address-details">
            <p>{{ endereco.logradouro }}, {{ endereco.numero }}</p>
            <p *ngIf="endereco.complemento">{{ endereco.complemento }}</p>
            <p>{{ endereco.bairro }} - {{ endereco.cidade.nome }}</p>
            <p>CEP: {{ endereco.cep }}</p>
          </div>
          
          <div class="address-actions">
            <button class="btn-text" (click)="adicionarEnderecoDialog(endereco)">
              <i class="material-icons">edit</i>
              Editar
            </button>
            <!-- <button *ngIf="!address.isPrimary" class="btn-text" (click)="setPrimaryAddress(address.id)">
              <i class="material-icons">star</i>
              Tornar Principal
            </button> -->
            <button class="btn-text delete" (click)="deleteAddress(endereco.id)">
              <i class="material-icons">delete</i>
              Excluir
            </button>
          </div>
        </div>
      </div>
      
      <!-- Address Form -->
      <div *ngIf="showAddressForm" class="address-form">
        <h3>{{ editingAddressId ? 'Editar' : 'Adicionar' }} Endereço</h3>
        <form [formGroup]="addressForm">
          <div class="form-row">
            <div class="form-group">
              <label for="addressName">Nome do Endereço</label>
              <input type="text" id="addressName" formControlName="name" placeholder="Ex: Casa, Trabalho">
              <div *ngIf="hasError(addressForm, 'name')" class="error-message">
                Nome é obrigatório
              </div>
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group address-street">
              <label for="addressStreet">Endereço</label>
              <input type="text" id="addressStreet" formControlName="address">
              <div *ngIf="hasError(addressForm, 'address')" class="error-message">
                Endereço é obrigatório
              </div>
            </div>
            
            <div class="form-group address-number">
              <label for="addressNumber">Número</label>
              <input type="text" id="addressNumber" formControlName="number">
              <div *ngIf="hasError(addressForm, 'number')" class="error-message">
                Número é obrigatório
              </div>
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="complement">Complemento</label>
              <input type="text" id="complement" formControlName="complement" placeholder="Apto, Bloco, etc.">
            </div>
            
            <div class="form-group">
              <label for="neighborhood">Bairro</label>
              <input type="text" id="neighborhood" formControlName="neighborhood">
              <div *ngIf="hasError(addressForm, 'neighborhood')" class="error-message">
                Bairro é obrigatório
              </div>
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="city">Cidade</label>
              <input type="text" id="city" formControlName="city">
              <div *ngIf="hasError(addressForm, 'city')" class="error-message">
                Cidade é obrigatória
              </div>
            </div>
            
            <div class="form-group">
              <label for="state">Estado</label>
              <select id="state" formControlName="state">
                <option value="">Selecione</option>
                <option value="SP">São Paulo</option>
                <option value="RJ">Rio de Janeiro</option>
                <option value="MG">Minas Gerais</option>
                <!-- Add more states as needed -->
              </select>
              <div *ngIf="hasError(addressForm, 'state')" class="error-message">
                Estado é obrigatório
              </div>
            </div>
            
            <div class="form-group">
              <label for="zipCode">CEP</label>
              <input type="text" id="zipCode" formControlName="zipCode" placeholder="00000-000">
              <div *ngIf="hasError(addressForm, 'zipCode')" class="error-message">
                CEP é obrigatório
              </div>
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group checkbox-group">
              <input type="checkbox" id="isPrimaryAddress" formControlName="isPrimary">
              <label for="isPrimaryAddress">Definir como endereço principal</label>
            </div>
          </div>
          
          <div class="form-actions">
            <button type="button" class="btn-primary" (click)="saveAddress()">
              {{ editingAddressId ? 'Atualizar' : 'Salvar' }} Endereço
            </button>
            <button type="button" class="btn-outline" (click)="showAddressForm = false">
              Cancelar
            </button>
          </div>
        </form>
      </div>
    </div>
    
    <!-- Tab 3: Credit Cards -->
    <div *ngIf="activeTab === 3" class="tab-panel cards">
      <div class="section-header">
        <h2>Meus Cartões</h2>
        <button class="btn-primary" (click)="addCard()">
          <i class="material-icons">add</i>
          Adicionar Cartão
        </button>
      </div>
      
      <!-- Card List -->
      <div class="card-list">
        <div *ngFor="let card of creditCards" class="credit-card" [class.primary]="card.isPrimary">
          <div class="card-header">
            <div class="card-brand">
              <i class="material-icons">credit_card</i>
              <span>{{ card.brand }}</span>
            </div>
            <span *ngIf="card.isPrimary" class="primary-badge">Principal</span>
          </div>
          
          <div class="card-details">
            <h3>{{ card.name }}</h3>
            <p class="card-number">{{ card.number }}</p>
            <p class="card-expiry">Válido até: {{ card.expiryDate }}</p>
          </div>
          
          <div class="card-actions">
            <button class="btn-text" (click)="editCard(card)">
              <i class="material-icons">edit</i>
              Editar
            </button>
            <button *ngIf="!card.isPrimary" class="btn-text" (click)="setPrimaryCard(card.id)">
              <i class="material-icons">star</i>
              Tornar Principal
            </button>
            <button class="btn-text delete" (click)="deleteCard(card.id)">
              <i class="material-icons">delete</i>
              Excluir
            </button>
          </div>
        </div>
      </div>
      
      <!-- Card Form -->
      <div *ngIf="showCardForm" class="card-form">
        <h3>{{ editingCardId ? 'Editar' : 'Adicionar' }} Cartão</h3>
        <form [formGroup]="cardForm">
          <div class="form-row">
            <div class="form-group">
              <label for="cardName">Nome do Cartão</label>
              <input type="text" id="cardName" formControlName="name" placeholder="Ex: Cartão Principal">
              <div *ngIf="hasError(cardForm, 'name')" class="error-message">
                Nome é obrigatório
              </div>
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="cardNumber">Número do Cartão</label>
              <input type="text" id="cardNumber" formControlName="number" placeholder="0000 0000 0000 0000">
              <div *ngIf="hasError(cardForm, 'number')" class="error-message">
                Número do cartão é obrigatório
              </div>
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="expiryDate">Data de Validade</label>
              <input type="text" id="expiryDate" formControlName="expiryDate" placeholder="MM/AA">
              <div *ngIf="hasError(cardForm, 'expiryDate')" class="error-message">
                Data de validade é obrigatória
              </div>
            </div>
            
            <div class="form-group">
              <label for="cvv">CVV</label>
              <input type="text" id="cvv" formControlName="cvv" placeholder="123">
              <div *ngIf="hasError(cardForm, 'cvv')" class="error-message">
                CVV é obrigatório
              </div>
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group checkbox-group">
              <input type="checkbox" id="isPrimaryCard" formControlName="isPrimary">
              <label for="isPrimaryCard">Definir como cartão principal</label>
            </div>
          </div>
          
          <div class="form-actions">
            <button type="button" class="btn-primary" (click)="saveCard()">
              {{ editingCardId ? 'Atualizar' : 'Salvar' }} Cartão
            </button>
            <button type="button" class="btn-outline" (click)="showCardForm = false">
              Cancelar
            </button>
          </div>
        </form>
      </div>
    </div>
    
    <!-- Tab 4: Wishlist -->
    <div *ngIf="activeTab === 4" class="tab-panel wishlist">
      <h2>Minha Lista de Desejos</h2>
      
      <div *ngIf="wishlistItems.length === 0" class="empty-wishlist">
        <div class="empty-icon">
          <i class="material-icons">favorite_border</i>
        </div>
        <h3>Sua lista de desejos está vazia</h3>
        <p>Adicione produtos que você gostaria de comprar mais tarde.</p>
        <button class="btn-primary" routerLink="/products">Explorar Produtos</button>
      </div>
      
      <div *ngIf="wishlistItems.length > 0" class="wishlist-grid">
        <div *ngFor="let item of wishlistItems" class="wishlist-item">
          <div class="item-image">
            <img [src]="item.image" [alt]="item.name">
            <div *ngIf="item.onSale" class="sale-badge">Promoção</div>
            <div *ngIf="!item.inStock" class="out-of-stock-badge">Fora de Estoque</div>
          </div>
          
          <div class="item-details">
            <h3>{{ item.name }}</h3>
            
            <div class="item-price">
              <span class="current-price">R$ {{ item.price.toFixed(2) }}</span>
              <span *ngIf="item.originalPrice" class="original-price">
                R$ {{ item.originalPrice.toFixed(2) }}
              </span>
            </div>
            
            <div class="item-status">
              <span *ngIf="item.inStock" class="in-stock">
                <i class="material-icons">check_circle</i>
                Em estoque
              </span>
              <span *ngIf="!item.inStock" class="out-of-stock">
                <i class="material-icons">cancel</i>
                Fora de estoque
              </span>
            </div>
          </div>
          
          <div class="item-actions">
            <button 
              class="btn-primary" 
              [disabled]="!item.inStock"
              (click)="addToCart(item)">
              <i class="material-icons">shopping_cart</i>
              {{ item.inStock ? 'Adicionar ao Carrinho' : 'Indisponível' }}
            </button>
            
            <button class="btn-outline" (click)="removeFromWishlist(item.id)">
              <i class="material-icons">delete</i>
              Remover
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
